{"version":3,"sources":["../../src/datasource-zabbix/queryProcessor.service.js"],"names":[],"mappings":"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","file":"queryProcessor.service.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\nimport * as utils from './utils';\n\n/** @ngInject */\nangular.module('grafana.services').factory('QueryProcessor', function($q) {\n\n  class QueryProcessor {\n    constructor(zabbixCacheInstance) {\n      this.cache = zabbixCacheInstance;\n      this.$q = $q;\n    }\n\n    /**\n     * Build query in asynchronous manner\n     */\n    build(groupFilter, hostFilter, appFilter, itemFilter, itemtype) {\n      var self = this;\n      if (this.cache._initialized) {\n        return this.$q.when(self.buildFromCache(groupFilter, hostFilter, appFilter, itemFilter, itemtype));\n      } else {\n        return this.cache.refresh().then(function() {\n          return self.buildFromCache(groupFilter, hostFilter, appFilter, itemFilter, itemtype);\n        });\n      }\n    }\n\n    /**\n     * Build trigger query in asynchronous manner\n     */\n    buildTriggerQuery(groupFilter, hostFilter, appFilter) {\n      var self = this;\n      if (this.cache._initialized) {\n        return this.$q.when(self.buildTriggerQueryFromCache(groupFilter, hostFilter, appFilter));\n      } else {\n        return this.cache.refresh().then(function() {\n          return self.buildTriggerQueryFromCache(groupFilter, hostFilter, appFilter);\n        });\n      }\n    }\n\n    filterGroups(groups, groupFilter) {\n      return this.$q.when(\n        findByFilter(groups, groupFilter)\n      );\n    }\n\n    /**\n     * Get list of host belonging to given groups.\n     * @return list of hosts\n     */\n    filterHosts(hosts, hostFilter) {\n      return this.$q.when(\n        findByFilter(hosts, hostFilter)\n      );\n    }\n\n    filterApps(apps, appFilter) {\n      return this.$q.when(\n        findByFilter(apps, appFilter)\n      );\n    }\n\n    /**\n     * Build query - convert target filters to array of Zabbix items\n     */\n    buildFromCache(groupFilter, hostFilter, appFilter, itemFilter, itemtype, showDisabledItems) {\n      return this.getItems(groupFilter, hostFilter, appFilter, itemtype, showDisabledItems)\n        .then(items => {\n          return getByFilter(items, itemFilter);\n        });\n    }\n\n    getGroups() {\n      return this.cache.getGroups();\n    }\n\n    /**\n     * Get list of host belonging to given groups.\n     * @return list of hosts\n     */\n    getHosts(groupFilter) {\n      var self = this;\n      return this.cache\n        .getGroups()\n        .then(groups => {\n          return findByFilter(groups, groupFilter);\n        })\n        .then(groups => {\n          var groupids = _.map(groups, 'groupid');\n          return self.cache.getHosts(groupids);\n        });\n    }\n\n    /**\n     * Get list of applications belonging to given groups and hosts.\n     * @return  list of applications belonging to given hosts\n     */\n    getApps(groupFilter, hostFilter) {\n      var self = this;\n      return this.getHosts(groupFilter)\n        .then(hosts => {\n          return findByFilter(hosts, hostFilter);\n        })\n        .then(hosts => {\n          var hostids = _.map(hosts, 'hostid');\n          return self.cache.getApps(hostids);\n        });\n    }\n\n    getItems(groupFilter, hostFilter, appFilter, itemtype, showDisabledItems) {\n      var self = this;\n      return this.getHosts(groupFilter)\n        .then(hosts => {\n          return findByFilter(hosts, hostFilter);\n        })\n        .then(hosts => {\n          var hostids = _.map(hosts, 'hostid');\n          if (appFilter) {\n            return self.cache\n              .getApps(hostids)\n              .then(apps => {\n                // Use getByFilter for proper item filtering\n                return getByFilter(apps, appFilter);\n              });\n          } else {\n            return {\n              appFilterEmpty: true,\n              hostids: hostids\n            };\n          }\n        })\n        .then(apps => {\n          if (apps.appFilterEmpty) {\n            return self.cache\n              .getItems(apps.hostids, undefined, itemtype)\n              .then(items => {\n                if (showDisabledItems) {\n                  items = _.filter(items, {'status': '0'});\n                }\n                return items;\n              });\n          } else {\n            var appids = _.map(apps, 'applicationid');\n            return self.cache\n              .getItems(undefined, appids, itemtype)\n              .then(items => {\n                if (showDisabledItems) {\n                  items = _.filter(items, {'status': '0'});\n                }\n                return items;\n              });\n          }\n        });\n    }\n\n    /**\n     * Build query - convert target filters to array of Zabbix items\n     */\n    buildTriggerQueryFromCache(groupFilter, hostFilter, appFilter) {\n      var promises = [\n        this.cache.getGroups().then(function(groups) {\n          return _.filter(groups, function(group) {\n            if (utils.isRegex(groupFilter)) {\n              return utils.buildRegex(groupFilter).test(group.name);\n            } else {\n              return group.name === groupFilter;\n            }\n          });\n        }),\n        this.getHosts(groupFilter).then(function(hosts) {\n          return _.filter(hosts, function(host) {\n            if (utils.isRegex(hostFilter)) {\n              return utils.buildRegex(hostFilter).test(host.name);\n            } else {\n              return host.name === hostFilter;\n            }\n          });\n        }),\n        this.getApps(groupFilter, hostFilter).then(function(apps) {\n          return _.filter(apps, function(app) {\n            if (utils.isRegex(appFilter)) {\n              return utils.buildRegex(appFilter).test(app.name);\n            } else {\n              return app.name === appFilter;\n            }\n          });\n        })\n      ];\n\n      return this.$q.all(promises).then(function(results) {\n        var filteredGroups = results[0];\n        var filteredHosts = results[1];\n        var filteredApps = results[2];\n        var query = {};\n\n        if (appFilter) {\n          query.applicationids = _.flatten(_.map(filteredApps, 'applicationid'));\n        }\n        if (hostFilter) {\n          query.hostids = _.map(filteredHosts, 'hostid');\n        }\n        if (groupFilter) {\n          query.groupids = _.map(filteredGroups, 'groupid');\n        }\n\n        return query;\n      });\n    }\n\n    /**\n     * Convert Zabbix API history.get response to Grafana format\n     *\n     * @return {Array}            Array of timeseries in Grafana format\n     *                            {\n     *                               target: \"Metric name\",\n     *                               datapoints: [[<value>, <unixtime>], ...]\n     *                            }\n     */\n    convertHistory(history, items, addHostName, convertPointCallback) {\n      /**\n       * Response should be in the format:\n       * data: [\n       *          {\n       *             target: \"Metric name\",\n       *             datapoints: [[<value>, <unixtime>], ...]\n       *          }, ...\n       *       ]\n       */\n\n      // Group history by itemid\n      var grouped_history = _.groupBy(history, 'itemid');\n      var hosts = _.flatten(_.map(items, 'hosts'));\n\n      return _.map(grouped_history, function(hist, itemid) {\n        var item = _.find(items, {'itemid': itemid});\n        var alias = item.name;\n        if (_.keys(hosts).length > 1 || addHostName) {\n          var host = _.find(hosts, {'hostid': item.hostid});\n          alias = host.name + \": \" + alias;\n        }\n        return {\n          target: alias,\n          datapoints: _.map(hist, convertPointCallback)\n        };\n      });\n    }\n\n    handleHistory(history, items, addHostName) {\n      return this.convertHistory(history, items, addHostName, convertHistoryPoint);\n    }\n\n    handleTrends(history, items, addHostName, valueType) {\n      var convertPointCallback = _.partial(convertTrendPoint, valueType);\n      return this.convertHistory(history, items, addHostName, convertPointCallback);\n    }\n\n    handleSLAResponse(itservice, slaProperty, slaObject) {\n      var targetSLA = slaObject[itservice.serviceid].sla[0];\n      if (slaProperty.property === 'status') {\n        var targetStatus = parseInt(slaObject[itservice.serviceid].status);\n        return {\n          target: itservice.name + ' ' + slaProperty.name,\n          datapoints: [\n            [targetStatus, targetSLA.to * 1000]\n          ]\n        };\n      } else {\n        return {\n          target: itservice.name + ' ' + slaProperty.name,\n          datapoints: [\n            [targetSLA[slaProperty.property], targetSLA.from * 1000],\n            [targetSLA[slaProperty.property], targetSLA.to * 1000]\n          ]\n        };\n      }\n    }\n  }\n\n  return QueryProcessor;\n});\n\n/**\n * Find group, host, app or item by given name.\n * @param  list list of groups, apps or other\n * @param  name visible name\n * @return      array with finded element or undefined\n */\nfunction findByName(list, name) {\n  var finded = _.find(list, {'name': name});\n  if (finded) {\n    return [finded];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Different hosts can contains applications and items with same name.\n * For this reason use _.filter, which return all elements instead _.find,\n * which return only first finded.\n * @param  {[type]} list list of elements\n * @param  {[type]} name app name\n * @return {[type]}      array with finded element or undefined\n */\nfunction filterByName(list, name) {\n  var finded = _.filter(list, {'name': name});\n  if (finded) {\n    return finded;\n  } else {\n    return undefined;\n  }\n}\n\nfunction findByRegex(list, regex) {\n  var filterPattern = utils.buildRegex(regex);\n  return _.filter(list, function (zbx_obj) {\n    return filterPattern.test(zbx_obj.name);\n  });\n}\n\nfunction findByFilter(list, filter) {\n  if (utils.isRegex(filter)) {\n    return findByRegex(list, filter);\n  } else {\n    return findByName(list, filter);\n  }\n}\n\nfunction getByFilter(list, filter) {\n  if (utils.isRegex(filter)) {\n    return findByRegex(list, filter);\n  } else {\n    return filterByName(list, filter);\n  }\n}\n\nfunction convertHistoryPoint(point) {\n  // Value must be a number for properly work\n  return [\n    Number(point.value),\n    point.clock * 1000\n  ];\n}\n\nfunction convertTrendPoint(valueType, point) {\n  var value;\n  switch (valueType) {\n    case \"min\":\n      value = point.value_min;\n      break;\n    case \"max\":\n      value = point.value_max;\n      break;\n    case \"avg\":\n      value = point.value_avg;\n      break;\n    default:\n      value = point.value_avg;\n  }\n\n  return [\n    Number(value),\n    point.clock * 1000\n  ];\n}\n"]}