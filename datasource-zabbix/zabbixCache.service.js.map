{"version":3,"sources":["../../src/datasource-zabbix/zabbixCache.service.js"],"names":[],"mappings":"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","file":"zabbixCache.service.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\nimport * as utils from './utils';\n\n// Use factory() instead service() for multiple datasources support.\n// Each datasource instance must initialize its own cache.\n\n/** @ngInject */\nangular.module('grafana.services').factory('ZabbixCachingProxy', function($q, $interval) {\n\n  class ZabbixCachingProxy {\n    constructor(zabbixAPI, ttl) {\n      this.zabbixAPI = zabbixAPI;\n      this.ttl = ttl;\n\n      this.$q = $q;\n\n      // Internal objects for data storing\n      this._groups        = undefined;\n      this._hosts         = undefined;\n      this._applications  = undefined;\n      this._items         = undefined;\n      this.storage = {\n        history: {},\n        trends: {}\n      };\n\n      // Check is a service initialized or not\n      this._initialized = undefined;\n\n      this.refreshPromise = false;\n      this.historyPromises = {};\n\n      // Wrap _refresh() method to call it once.\n      this.refresh = callOnce(this._refresh, this.refreshPromise);\n\n      // Update cache periodically\n      $interval(_.bind(this.refresh, this), this.ttl);\n\n      // Don't run duplicated history requests\n      this.getHistory = callHistoryOnce(_.bind(this.zabbixAPI.getHistory, this.zabbixAPI),\n                                        this.historyPromises);\n\n      // Don't run duplicated requests\n      this.groupPromises = {};\n      this.getGroupsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGroups, this.zabbixAPI),\n                                              this.groupPromises);\n\n      this.hostPromises = {};\n      this.getHostsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getHosts, this.zabbixAPI),\n                                             this.hostPromises);\n\n      this.appPromises = {};\n      this.getAppsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getApps, this.zabbixAPI),\n                                            this.appPromises);\n\n      this.itemPromises = {};\n      this.getItemsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItems, this.zabbixAPI),\n                                             this.itemPromises);\n    }\n\n    _refresh() {\n      var self = this;\n      var promises = [\n        this.zabbixAPI.getGroups()\n      ];\n\n      return this.$q.all(promises).then(function(results) {\n        if (results.length) {\n          self._groups = results[0];\n        }\n        self._initialized = true;\n      });\n    }\n\n    getGroups() {\n      var self = this;\n      if (this._groups) {\n        return this.$q.when(self._groups);\n      } else {\n        return this.getGroupsOnce()\n          .then(groups => {\n            self._groups = groups;\n            return self._groups;\n          });\n      }\n    }\n\n    getHosts(groupids) {\n      var self = this;\n      return this.getHostsOnce(groupids)\n        .then(hosts => {\n          self._hosts = _.union(self._hosts, hosts);\n          return hosts;\n        });\n    }\n\n    getApps(hostids) {\n      return this.getAppsOnce(hostids)\n        .then(apps => {\n          return apps;\n        });\n    }\n\n    getItems(hostids, appids, itemtype) {\n      var self = this;\n      return this.getItemsOnce(hostids, appids, itemtype)\n        .then(items => {\n          self._items = _.union(self._items, items);\n          return items;\n        });\n    }\n\n    getHistoryFromCache(items, time_from, time_till) {\n      var deferred  = this.$q.defer();\n      var historyStorage = this.storage.history;\n      var full_history;\n      var expired = _.filter(_.indexBy(items, 'itemid'), function(item, itemid) {\n        return !historyStorage[itemid];\n      });\n      if (expired.length) {\n        this.zabbixAPI.getHistory(expired, time_from, time_till).then(function(history) {\n          var grouped_history = _.groupBy(history, 'itemid');\n          _.forEach(expired, function(item) {\n            var itemid = item.itemid;\n            historyStorage[itemid] = item;\n            historyStorage[itemid].time_from = time_from;\n            historyStorage[itemid].time_till = time_till;\n            historyStorage[itemid].history = grouped_history[itemid];\n          });\n          full_history = _.map(items, function(item) {\n            return historyStorage[item.itemid].history;\n          });\n          deferred.resolve(_.flatten(full_history, true));\n        });\n      } else {\n        full_history = _.map(items, function(item) {\n          return historyStorage[item.itemid].history;\n        });\n        deferred.resolve(_.flatten(full_history, true));\n      }\n      return deferred.promise;\n    }\n\n    getHistoryFromAPI(items, time_from, time_till) {\n      return this.zabbixAPI.getHistory(items, time_from, time_till);\n    }\n\n    getHost(hostid) {\n      return _.find(this._hosts, {'hostid': hostid});\n    }\n\n    getItem(itemid) {\n      return _.find(this._items, {'itemid': itemid});\n    }\n  }\n\n  function callAPIRequestOnce(func, promiseKeeper) {\n    return function() {\n      var hash = getAPIRequestHash(arguments);\n      var deferred  = $q.defer();\n      if (!promiseKeeper[hash]) {\n        promiseKeeper[hash] = deferred.promise;\n        func.apply(this, arguments).then(function(result) {\n          deferred.resolve(result);\n          promiseKeeper[hash] = null;\n        });\n      } else {\n        return promiseKeeper[hash];\n      }\n      return deferred.promise;\n    };\n  }\n\n  function callHistoryOnce(func, promiseKeeper) {\n    return function() {\n      var itemids = _.map(arguments[0], 'itemid');\n      var stamp = itemids.join() + arguments[1] + arguments[2];\n      var hash = stamp.getHash();\n\n      var deferred  = $q.defer();\n      if (!promiseKeeper[hash]) {\n        promiseKeeper[hash] = deferred.promise;\n        func.apply(this, arguments).then(function(result) {\n          deferred.resolve(result);\n          promiseKeeper[hash] = null;\n        });\n      } else {\n        return promiseKeeper[hash];\n      }\n      return deferred.promise;\n    };\n  }\n\n  function callOnce(func, promiseKeeper) {\n    return function() {\n      var deferred  = $q.defer();\n      if (!promiseKeeper) {\n        promiseKeeper = deferred.promise;\n        func.apply(this, arguments).then(function(result) {\n          deferred.resolve(result);\n          promiseKeeper = null;\n        });\n      } else {\n        return promiseKeeper;\n      }\n      return deferred.promise;\n    };\n  }\n\n  return ZabbixCachingProxy;\n});\n\nfunction getAPIRequestHash(args) {\n  var requestStamp = _.map(args, arg => {\n    if (arg === undefined) {\n      return 'undefined';\n    } else {\n      return arg.toString();\n    }\n  }).join();\n  return requestStamp.getHash();\n}\n\nString.prototype.getHash = function() {\n  var hash = 0, i, chr, len;\n  if (this.length === 0) {\n    return hash;\n  }\n  for (i = 0, len = this.length; i < len; i++) {\n    chr   = this.charCodeAt(i);\n    hash  = ((hash << 5) - hash) + chr;\n    hash |= 0; // Convert to 32bit integer\n  }\n  return hash;\n};\n"]}