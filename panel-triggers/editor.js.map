{"version":3,"sources":["../../src/panel-triggers/editor.js"],"names":[],"mappings":"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","file":"editor.js","sourcesContent":["/**\n * Grafana-Zabbix\n * Zabbix plugin for Grafana.\n * http://github.com/alexanderzobnin/grafana-zabbix\n *\n * Trigger panel.\n * This feature sponsored by CORE IT\n * http://www.coreit.fr\n *\n * Copyright 2015 Alexander Zobnin alexanderzobnin@gmail.com\n * Licensed under the Apache License, Version 2.0\n */\n\nimport _ from 'lodash';\nimport * as utils from '../datasource-zabbix/utils';\n\nimport '../datasource-zabbix/css/query-editor.css!';\n\nclass TriggerPanelEditorCtrl {\n\n  /** @ngInject */\n  constructor($scope, $rootScope, uiSegmentSrv, datasourceSrv, templateSrv, popoverSrv) {\n    $scope.editor = this;\n    this.panelCtrl = $scope.ctrl;\n    this.panel = this.panelCtrl.panel;\n\n    this.datasourceSrv = datasourceSrv;\n    this.templateSrv = templateSrv;\n    this.popoverSrv = popoverSrv;\n\n    // Map functions for bs-typeahead\n    this.getGroupNames = _.partial(getMetricNames, this, 'groupList');\n    this.getHostNames = _.partial(getMetricNames, this, 'hostList');\n    this.getApplicationNames = _.partial(getMetricNames, this, 'appList');\n\n    // Update metric suggestion when template variable was changed\n    $rootScope.$on('template-variable-value-updated', () => this.onVariableChange());\n\n    this.ackFilters = [\n      'all triggers',\n      'unacknowledged',\n      'acknowledged'\n    ];\n\n    this.sortByFields = [\n      { text: 'last change',  value: 'lastchange' },\n      { text: 'severity',     value: 'priority' }\n    ];\n\n    this.showEventsFields = [\n      { text: 'All',     value: [0,1] },\n      { text: 'OK',      value: [0] },\n      { text: 'Problems', value: 1 }\n    ];\n\n    // Load scope defaults\n    var scopeDefaults = {\n      metric: {},\n      inputStyles: {},\n      oldTarget: _.cloneDeep(this.panel.triggers)\n    };\n    _.defaults(this, scopeDefaults);\n\n    // Get zabbix data sources\n    var datasources = _.filter(this.datasourceSrv.getMetricSources(), datasource => {\n      return datasource.meta.id === 'alexanderzobnin-zabbix-datasource';\n    });\n    this.datasources = _.map(datasources, 'name');\n\n    // Set default datasource\n    if (!this.panel.datasource) {\n      this.panel.datasource = this.datasources[0];\n    }\n    // Load datasource\n    this.datasourceSrv.get(this.panel.datasource)\n    .then(datasource => {\n      this.datasource = datasource;\n      this.queryBuilder = datasource.queryBuilder;\n      this.initFilters();\n      this.panelCtrl.refresh();\n    });\n  }\n\n  initFilters() {\n    return Promise.all([\n      this.suggestGroups(),\n      this.suggestHosts(),\n      this.suggestApps()\n    ]);\n  }\n\n  suggestGroups() {\n    return this.queryBuilder.getAllGroups()\n    .then(groups => {\n      this.metric.groupList = groups;\n      return groups;\n    });\n  }\n\n  suggestHosts() {\n    let groupFilter = this.datasource.replaceTemplateVars(this.panel.triggers.group.filter);\n    return this.queryBuilder.getAllHosts(groupFilter)\n    .then(hosts => {\n      this.metric.hostList = hosts;\n      return hosts;\n    });\n  }\n\n  suggestApps() {\n    let groupFilter = this.datasource.replaceTemplateVars(this.panel.triggers.group.filter);\n    let hostFilter = this.datasource.replaceTemplateVars(this.panel.triggers.host.filter);\n    return this.queryBuilder.getAllApps(groupFilter, hostFilter)\n    .then(apps => {\n      this.metric.appList = apps;\n      return apps;\n    });\n  }\n\n  onVariableChange() {\n    if (this.isContainsVariables()) {\n      this.targetChanged();\n    }\n  }\n\n  /**\n   * Check query for template variables\n   */\n  isContainsVariables() {\n    var self = this;\n    return _.some(self.templateSrv.variables, variable => {\n      return _.some(['group', 'host', 'application'], field => {\n        return self.templateSrv.containsVariable(self.panel.triggers[field].filter, variable.name);\n      });\n    });\n  }\n\n  targetChanged() {\n    this.initFilters();\n    this.panelCtrl.refresh();\n  }\n\n  parseTarget() {\n    this.initFilters();\n    var newTarget = _.cloneDeep(this.panel.triggers);\n    if (!_.isEqual(this.oldTarget, this.panel.triggers)) {\n      this.oldTarget = newTarget;\n      this.panelCtrl.refresh();\n    }\n  }\n\n  refreshTriggerSeverity() {\n    _.each(this.triggerList, function(trigger) {\n      trigger.color = this.panel.triggerSeverity[trigger.priority].color;\n      trigger.severity = this.panel.triggerSeverity[trigger.priority].severity;\n    });\n    this.panelCtrl.refresh();\n  }\n\n  datasourceChanged() {\n    this.panelCtrl.refresh();\n  }\n\n  changeTriggerSeverityColor(trigger, color) {\n    this.panel.triggerSeverity[trigger.priority].color = color;\n    this.refreshTriggerSeverity();\n  }\n\n  isRegex(str) {\n    return utils.isRegex(str);\n  }\n\n  isVariable(str) {\n    return utils.isTemplateVariable(str, this.templateSrv.variables);\n  }\n}\n\n// Get list of metric names for bs-typeahead directive\nfunction getMetricNames(scope, metricList) {\n  return _.uniq(_.map(scope.metric[metricList], 'name'));\n}\n\nexport function triggerPanelEditor() {\n  return {\n    restrict: 'E',\n    scope: true,\n    templateUrl: 'public/plugins/alexanderzobnin-zabbix-app/panel-triggers/editor.html',\n    controller: TriggerPanelEditorCtrl,\n  };\n}\n"]}